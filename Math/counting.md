# 计数

## 树计数

### Prufer序列

定义：一棵有标号树的Prufer序列为递归地将其最小的叶节点删去并将其邻点标号加入序列末尾直到剩余两个点所得序列。

Prufer序列转化为树：

维护一个集合$S$，初始$S=\{1,2,...,n\}$。对于序列中从左到右的每个元素$u$，找到未在其右侧出现的$S$中的最小元素$v$并将$u,v$连边，然后将$v$从$S$中删去，最后将$S$中剩余两个点连边即可完成对树的还原。

扩展——森林的Prufer序列：

定义：一个$n$个点的有$k$个连通块组成的森林的Prufer序列与树的构造方式几乎相同，唯一的区别是剩余$k+1$个点时停止。易得$n$个点$k$个连通块组成的森林的$Prufer$序列长度为$n-k$

1. 先钦定$k$个根

2. 第$n-k$个位置的值为$k$个根之一。

3. 前$n-k-1$个位置上的值任意。

不难得到$n$个点，有$k$个连通块的森林数量为$\binom nk kn^{n-k-1}$

### 有标号无根树计数

定理(Caylay)：$n$个点的有标号无根树共有$n^{n-2}$种。从Prufer序列的构造与还原不难看出一棵树对应着一个Prufer序列，而每个Prufer序列在其$n-2$个位置均有$n$种取值可能。

法2：

枚举叶子个数$k$，可得到

当$0 \leq n \leq 2$时有$F(n)=1$，否则有$F(n)=\sum_{k=1}^{n-1}{\binom nk (n-k)^{k}F(n-k)}$

### 有标号有根树计数

给每个有标号无根树定一个根即可得到有标号有根树，因而$n$个点的有标号有根树共有$n^{n-1}$种。

### 有标号基环树计数

考虑魔改Prufer序列，先钦定$k$个点在环上，方案为$\binom nk$。

将环上的边都断开并将所有环上的点连向一个标号为正无穷的特殊点。

该树的Prufer序列具有如下性质：

1. 最后$k$个位置的值均为正无穷。

2. 第$n-k$个位置的值必为环上的$k$个点之一。

3. 前$n-k-1$个位置上的值任意。

k个点的环排列有$\frac{1}{2}k!$种，因而$n$个点的基环树个数为

$$
\sum_{k=3}^n{\binom nk \frac{k!}{2}n^{n-k-1}}=\frac 12 \sum_{k=3}^n{\frac{n!}{(n-k)!}n^{n-k-1}}
$$

考虑$n$个点基环树数量的OGF:

$$
F(x)=\frac 12 \sum_{i=0}^\infty\frac{x^i}{i!}\sum_{k=3}^i\frac{i!}{(i-k)!}i^{i-k-1}=\frac 12 \sum_{i=0}^\infty\frac{x^i}{i!}\sum_{k=0}^{i-3}\frac{i!}{k!}i^{k-1}=\frac 12 \sum_{i=0}^\infty x^i\sum_{k=0}^{i-3}\frac{i^{k-1}}{k!}
$$

### 无标号有根树计数

钦定根后剩下的子树方案数相当于一个完全背包。

考虑欧拉变换的定义可写出OGF相关的方程：

$$f(x)=x \mathscr E(f(x))$$

## 图计数

### 有标号连通图计数

对于满足某些性质的图（如欧拉图，即顶点度数均为偶数），用可以不连通的所有方案推广到连通的所有方案的情况可通过将所有方案减去不连通的方案获得。如枚举$1$号点所在连通块大小$k$，则除$1$号点之外的点共有$\binom{n-1}{k-1}$种方案：

$$f_n=g_n-\sum_{k=1}^{n-1}{\binom{n-1}{k-1}f_kg_{n-k}}$$

也可通过指数生成函数进行计数，即$G(x)=lnF(x)$，其中$F(x),G(x)$分别为$f_n,g_n$的EGF。具体见“$e^{F(x)}$的组合意义”

### 有标号二分图计数

法1：

设大小为$n$，有$m$个连通块的二分图数量为$F(n,m)$，则有：

$$F(n,m)=\sum_{k=1}^{n-m+1}{\binom{n-1}{k-1}F(k,1)F(n-k,m-1)}$$

设$G(n)$为大小为$n$，进行了黑白染色的二分图数量，则有:

$$G(n)=\sum_{m=0}^n{\binom{n}{m}2^{m(n-m)}}=\sum_{m=1}^n{2^mF(n,m)}$$

$$=2^1F(n,1)+\sum_{m=2}^n{2^m\sum_{k=1}^{n-m+1}{\binom{n-1}{k-1}F(k,1)F(n-k,m-1)}}$$

$$=2F(n,1)+\sum_{k=1}^{n-1}{\binom{n-1}{k-1}F(k,1)\sum_{m=2}^{n-k+1}{2^mF(n-k,m-1)}}$$

$$=2F(n,1)+2\sum_{k=1}^{n-1}{\binom{n-1}{k-1}F(k,1)\sum_{m=1}^{n-k}{2^mF(n-k,m)}}$$

$$=2F(n,1)+2\sum_{k=1}^{n-1}{\binom{n-1}{k-1}F(k,1)G(n-k)}$$

可得递推式:

$$F(n,1)=\frac{1}{2}G(n)-\sum_{k=1}^{n-1}{\binom{n-1}{k-1}{F(k,1)G(n-k)}}$$

注：
$$G(n)=\sum_{m=0}^n{\binom{n}{m}2^{m(n-m)}}=\sum_{m=0}^n{\binom{n}{m}2^{nm-m^2}}
=\sum_{m=0}^n{\frac{n!}{m!(n-m)!}2^{\frac{1}{2}(n^2+m^2-(n-m)^2)-m^2}}$$
$$=n!2^\frac{n^2}{2}\sum_{m=0}^n{\frac{1}{m!(n-m)!}2^{-\frac{(n-m)^2}{2}-\frac{m^2}{2}}}
=n!2^\frac{n^2}{2}\sum_{m=0}^n{\frac{2^{-\frac{(n-m)^2}{2}}}{m!}\frac{2^{-\frac{m^2}{2}}}{(n-m)!}}$$

法2：

考虑$n$个点的二染色的连通二分图的EGF为$H(x)$，二染色的二分图的EGF为$G(x)$，连通二分图的EGF为$F_1(x)$，二分图的EGF为$F_2(x)$，则显然$G(x)=e^{H(x)}$，且$H(x)=2F_1(x)$,$F_2(x)=e^{F_1(x)}$。

于是$F_2(x)=e^{F_1(x)}=e^{\frac{1}{2}H(x)}=e^{\frac{1}{2}lnG(x)}=\sqrt{G(x)}$。

### 有标号DAG计数

注意到DAG中存在一类特殊的点，即出度为$0$的点，我们通过枚举这些点进行计算。

设$F(n,S)$为$n$个点，有且仅有$S$中点出度为0的DAG数量。

设$G(n,S)$为$n$个点，至少有$S$中点出度为0的DAG数量。不难发现我们需要求的即是$G(n,\emptyset)$。

枚举$S$中点与其他点的连边，可得$G(n,S)=2^{|S|(n-|S|)}G(n-|S|,\emptyset)$

由$G$与$F$的定义可得

$$G(n,S)=\sum_{T \supseteq S}{F(n,T)}$$

$$F(n,S)=\sum_{T \supseteq S}{(-1)^{|T|-|S|}G(n,T)}$$

于是有

$$G(n,\emptyset)=\sum_{T \neq \emptyset}{F(n,T)}=\sum_{T \neq \emptyset}{\sum_{S\supseteq T}{(-1)^{|S|-|T|}G(n,S)}}$$

$$=\sum_{T \neq \emptyset}{\sum_{S\supseteq T}{(-1)^{|S|-|T|}2^{|S|(n-|S|)}G(n-|S|,\emptyset)}}$$

$$=\sum_{S\neq \emptyset}{(-1)^{|S|}2^{|S|(n-|S|)}G(n-|S|,\emptyset)\sum_{\emptyset \neq T\subseteq S}}{(-1)^{|T|}}$$

$$=\sum_{k=1}^{n}{(-1)^{k-1}\binom{n}{k}2^{k(n-k)}}G(n-k,\emptyset)$$

得到递推式：

$F(n)=\sum_{k=1}^n{(-1)^{k-1}\binom nk 2^{k(n-k)}F(n-k)}$

注：考虑上式的组合意义：

1. 从$n$个点中钦定$k$个点为0出度点有$\binom{n}{k}$种选法。

2. 其他$n-k$个点与$k$个点可以任意连边，方案数为$2^{k(n-k)}$。

3. 其他$n-k$个点之间共有$F(n-k)$种连边方式。

4. 因为任意连边可能造成这$k$个点之外的点出度也为0，所以式$\binom nk 2^{k(n-k)}F(n-k)$实际上是钦定了至少$k$个点为0出度点的$n$点DAG数量。

5. 考虑某种恰好有$k$个0出度点的DAG被哪些至少$i$个0出度点的方案统计了，可得重复统计次数为$\sum_{i=0}^{k}{\binom ki}=2^k$。不难发现加上容斥系数后即可使上式变为$\sum_{i=0}^{k}{\binom ki(-1)^{i+1}}=(-1)\sum_{i=0}^k{\binom ki(-1)^i}=\sum_{i=1}^k{\binom ki}(-1)^{i-1}-1$，因此给所有出度至少为$k$的DAG方案数乘上一个$(-1)^{k-1}$的容斥系数可保证所有方案均被统计恰好一次。

6. 因此$n$个点的DAG数量=至少$1$个点出度为0的$n$点DAG数量$-$至少$2$个点出度为0的$n$点DAG数量$+$至少$3$个点出度为$0$的$n$点DAG数量，等等。

### 有标号强连通图计数

设$n$的点的强连通图数量为$F(n)$，考虑用所有$n$个点的有向图的个数$H(n)$减去非强连通图的方案数来计算答案。

考虑DAG计数的过程，我们枚举非强连通图缩点后出度为$0$的强连通分量由哪些点组成，其他点与这些点之间可以任意连边。

可得：

$$F(n)=H(n)-\sum_{k=1}^{n}{\binom nk 2^{k(n-k)}H(n-k)G(k)}+F(n)$$

其中$G(k)$表示$k$个点组成数个互不相连的强连通分量的方案数。

右边加入$F(n)$的原因是，当$k$取到$n$时，该项表示的方案为$n$个点组成数个互不相连的强连通分量的方案数，即恰好包括了一个$F(n)$，因此要将其加回去。

由DAG计数可知，因为对$H(n-k)$中的连边方案没有任何限制，所以余下$n-k$个点中的点在缩点后也可能产生新的0出度点，即上述计数过程会造成重复统计。

我们仿照DAG计数，令$G(n,i)$表示$n$个点组成$i$个互不相连的强连通分量的方案数，并令$G(n)=\sum_{i=1}^{k}{(-1)^{i-1}G(n,i)}$,加入容斥系数来避免重复统计。

由前式可得关于$G(n)$的递推式：

$$H(n)=\sum_{k=1}^{n}{\binom nk 2^{k(n-k)}H(n-k)G(k)}$$

$$=\sum_{k=1}^{n-1}{\binom n k 2^{k(n-k)}H(n-k)G(k)}+G(n)$$

于是

$$G(n)=H(n)-\sum_{k=1}^{n-1}{\binom nk 2^{k(n-k)}H(n-k)G(k)}$$

考虑用$G(n)$获得$F(n)$的递推式，因为$F(n)=G(n,1)$，因此我们考虑通过枚举1号点所在强连通分量大小计算$\sum_{i=2}^{n}{(-1)^iG(n,i)}$然后加到$G(n)$上去。

$$F(n)=G(n,1)=G(n)+\sum_{i=2}^{n}{(-1)^iG(n,i)}$$

$$=G(n)+\sum_{i=2}^{n}{(-1)^i\sum_{k=1}^{n-i+1}{\binom {n-1}{k-1}G(k,1)G(n-k,i-1)}}$$

$$=G(n)+\sum_{k=1}^{n-1}{\binom {n-1}{k-1} G(k,1)\sum_{i=1}^{n-k}{(-1)^{i-1}G(n-k,i)}}$$

$$=G(n)+\sum_{k=1}^{n-1}{\binom {n-1}{k-1} F(k)G(n-k)}$$

注：$G(n,i)$可通过枚举1号点所在连通块大小获得递推式

$$G(n,i)=\sum_{k=1}^{n-i+1}{\binom {n-1}{k-1}G(k,1)G(n-k,i)}$$